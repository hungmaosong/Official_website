<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCG ç¸½éƒ¨å¾Œå° - æœ€é«˜æ¬Šé™ç®¡ç†</title>

    <link rel="icon" href="../assets/images/logo.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Orbitron:wght@500;700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="../css/main.css">

    <style>
        ::selection {
            background-color: var(--accent);
            color: #000000;
        }

        ::-moz-selection {
            background-color: var(--accent);
            color: #000000;
        }

        body {
            background-color: #020617;
        }

        .admin-sidebar {
            background: rgba(15, 23, 42, 0.9);
            border-right: 1px solid rgba(6, 182, 212, 0.3);
            min-height: 100vh;
            padding: 20px;
        }

        .admin-content {
            padding: 30px;
        }

        .stat-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s;
            height: 100%;
            /* ç¢ºä¿æ‰€æœ‰å¡ç‰‡é«˜åº¦ä¸€è‡´ */
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.2);
        }

        .stat-value {
            font-family: var(--font-title);
            font-size: 2.2rem;
            /* ç¨å¾®ç¸®å°å­—é«”ä»¥é©æ‡‰ 5 æ¬„æ’ç‰ˆ */
            color: var(--accent);
            font-weight: 700;
        }

        .nav-pills .nav-link {
            color: #94a3b8;
            border-radius: 8px;
            margin-bottom: 10px;
            font-family: var(--font-title);
            letter-spacing: 1px;
        }

        .nav-pills .nav-link.active {
            background-color: rgba(6, 182, 212, 0.1);
            color: var(--accent);
            border-left: 4px solid var(--accent);
        }

        .btn-admin-action {
            padding: 4px 10px;
            font-size: 0.85rem;
            border-radius: 6px;
            margin-right: 5px;
        }

        input[type="file"]::file-selector-button {
            background-color: var(--accent);
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            padding: 5px 15px;
            margin-right: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="file"]::file-selector-button:hover {
            background-color: #fff;
        }

        /* è‡ªè¨‚ 5 æ¬„ä½ç¶²æ ¼ç³»çµ± */
        .col-5-card {
            width: 20%;
            padding: 0 10px;
        }

        @media (max-width: 1200px) {
            .col-5-card {
                width: 33.33%;
                margin-bottom: 20px;
            }
        }

        @media (max-width: 768px) {
            .col-5-card {
                width: 50%;
                margin-bottom: 20px;
            }
        }

        @media (max-width: 576px) {
            .col-5-card {
                width: 100%;
                margin-bottom: 20px;
            }
        }
    </style>
</head>

<body>
    <script>
        const currentAdmin = localStorage.getItem('username');
        if (currentAdmin !== 'admin') {
            alert("ğŸš¨ åš´é‡è­¦å‘Šï¼šåµæ¸¬åˆ°æœªç¶“æˆæ¬Šçš„å­˜å–å˜—è©¦ï¼\néæœ€é«˜ç®¡ç†å“¡ (ADMIN) ç¦æ­¢é€²å…¥å¾Œå°ï¼\n\nç³»çµ±å°‡å¼·åˆ¶é©…é›¢...");
            window.location.href = '../index.html';
        }
    </script>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 admin-sidebar d-none d-md-block">
                <div class="text-center mb-5 mt-3">
                    <h4
                        style="color: #fff; font-family: var(--font-title); font-weight: bold; text-shadow: 0 0 10px var(--accent);">
                        KCG<br><span style="color: var(--accent); font-size: 0.8rem;">COMMAND CENTER</span>
                    </h4>
                </div>
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill"
                        data-bs-target="#v-pills-dashboard" type="button" role="tab">ğŸ“Š å„€è¡¨æ¿</button>
                    <button class="nav-link" id="v-pills-users-tab" data-bs-toggle="pill"
                        data-bs-target="#v-pills-users" type="button" role="tab">ğŸ•µï¸â€â™‚ï¸ æœƒå“¡åå†Š</button>
                    <button class="nav-link" id="v-pills-orders-tab" data-bs-toggle="pill"
                        data-bs-target="#v-pills-orders" type="button" role="tab">ğŸ“¦ è¨‚å–®ç®¡ç†</button>
                    <button class="nav-link" id="v-pills-inventory-tab" data-bs-toggle="pill"
                        data-bs-target="#v-pills-inventory" type="button" role="tab">ğŸ› ï¸ å•†å“åº«å­˜</button>
                </div>
                <div class="mt-5 text-center">
                    <a href="../index.html" class="btn btn-outline-secondary btn-sm w-100">è¿”å›é¦–é </a>
                </div>
            </div>

            <div class="col-md-10 admin-content">
                <div class="d-flex justify-content-between align-items-center mb-4 pb-3"
                    style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <h2 class="section-title mb-0" style="font-size: 1.8rem;">æ­¡è¿å›ä¾†ã€‚ <span class="highlight">SYSTEM
                            ONLINE</span></h2>
                    <span style="color: #94a3b8;" id="current-time"></span>
                </div>

                <div class="tab-content" id="v-pills-tabContent">
                    <div class="tab-pane fade show active" id="v-pills-dashboard" role="tabpanel">
                        <div class="d-flex flex-wrap mb-5" style="margin: 0 -10px;">
                            <div class="col-5-card">
                                <div class="stat-card">
                                    <div class="mb-2" style="color: #cbd5e1; font-weight: 600;">è¨»å†Šæœƒå“¡ç¸½æ•¸</div>
                                    <div class="stat-value" id="stat-users">0</div>
                                </div>
                            </div>
                            <div class="col-5-card">
                                <div class="stat-card">
                                    <div class="mb-2" style="color: #cbd5e1; font-weight: 600;">å¾…è™•ç†è¨‚å–®</div>
                                    <div class="stat-value" id="stat-orders" style="color: #38bdf8;">0</div>
                                </div>
                            </div>
                            <div class="col-5-card">
                                <div class="stat-card">
                                    <div class="mb-2" style="color: #cbd5e1; font-weight: 600;">ä½åº«å­˜è­¦å ±</div>
                                    <div class="stat-value" id="stat-low-stock" style="color: #ef4444;">0</div>
                                </div>
                            </div>
                            <div class="col-5-card">
                                <div class="stat-card">
                                    <div class="mb-2" style="color: #cbd5e1; font-weight: 600;">ç´¯ç©ç‡Ÿæ”¶</div>
                                    <div class="stat-value" id="stat-revenue" style="color: #22c55e;">NT$ 0</div>
                                </div>
                            </div>
                            <div class="col-5-card">
                                <div class="stat-card">
                                    <div class="mb-2" style="color: #cbd5e1; font-weight: 600;">ä¼ºæœå™¨ç‹€æ…‹</div>
                                    <div class="stat-value" id="stat-server"
                                        style="color: #f59e0b; font-size: 1.5rem; line-height: 1.5;">
                                        é€£ç·šä¸­...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="v-pills-users" role="tabpanel">
                        <div class="tech-card p-4">
                            <h4 class="mb-4" style="color: #fff; font-family: var(--font-title);">æœƒå“¡åå–®è³‡æ–™åº« <span
                                    style="font-size: 0.9rem; color: var(--accent);">[ USERS_DB ]</span></h4>
                            <div class="table-responsive">
                                <table class="table tech-table align-middle">
                                    <thead>
                                        <tr style="color: #cbd5e1;">
                                            <th>ä»£è™Ÿ (å¸³è™Ÿ)</th>
                                            <th>é¡¯ç¤ºåç¨±</th>
                                            <th>é€šè¨Šé »é“ (é›»è©±)</th>
                                            <th>é›»å­ä¿¡ç®±</th>
                                            <th>é è¨­é–€å¸‚</th>
                                            <th>è¨»å†Šæ™‚é–“</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-users-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="v-pills-orders" role="tabpanel">
                        <div class="tech-card p-4">
                            <h4 class="mb-4" style="color: #fff; font-family: var(--font-title);">è¨‚å–®è™•ç†ä¸­å¿ƒ <span
                                    style="font-size: 0.9rem; color: var(--accent);">[ ORDERS_LOG ]</span></h4>
                            <div class="table-responsive">
                                <table class="table tech-table align-middle">
                                    <thead>
                                        <tr style="color: #cbd5e1;">
                                            <th>è¨‚å–®ç·¨è™Ÿ</th>
                                            <th>æ”¶ä»¶äºº</th>
                                            <th>è³¼è²·é …ç›®</th>
                                            <th>ç¸½é‡‘é¡</th>
                                            <th>ç‹€æ…‹</th>
                                            <th>ä¸‹å–®æ™‚é–“</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-orders-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="v-pills-inventory" role="tabpanel">
                        <div class="tech-card p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="mb-0" style="color: #fff; font-family: var(--font-title);">å•†å“èˆ‡åº«å­˜ç®¡ç† <span
                                        style="font-size: 0.9rem; color: var(--accent);">[ PRODUCTS_DB ]</span></h4>
                                <button class="btn btn-primary" onclick="openProductModal()"
                                    style="border-radius: 50px; padding: 8px 20px; font-weight: bold;">â• æ–°å¢å•†å“</button>
                            </div>
                            <div class="table-responsive">
                                <table class="table tech-table align-middle">
                                    <thead>
                                        <tr style="color: #cbd5e1;">
                                            <th width="8%">ID</th>
                                            <th width="32%">å•†å“åç¨±</th>
                                            <th width="15%">åˆ†é¡</th>
                                            <th width="15%">å–®åƒ¹</th>
                                            <th width="10%">åº«å­˜</th>
                                            <th width="20%">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-products-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content tech-modal">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title tech-title" id="productModalLabel">âš™ï¸ å•†å“è¨­å®š (PRODUCT CONFIG)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="product-form">
                        <input type="hidden" id="prod-id">
                        <div class="row">
                            <div class="col-md-6 mb-3 input-group-tech"><label>å•†å“åç¨± (Name)</label><input type="text"
                                    class="form-control" id="prod-name" required></div>
                            <div class="col-md-6 mb-3 input-group-tech">
                                <label>æ‰€å±¬åˆ†é¡ (Category)</label>
                                <select class="form-control" id="prod-category" required style="cursor: pointer;">
                                    <option value="figure">æ™¯å“æ¨¡å‹ (figure)</option>
                                    <option value="card">ç¨€æœ‰å¡ç‰‡ (card)</option>
                                    <option value="clothes">æ½®æµæœé£¾ (clothes)</option>
                                    <option value="music">éŸ³æ¨‚å‘¨é‚Š (music)</option>
                                    <option value="other">å…¶ä»–é…ä»¶ (other)</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3 input-group-tech"><label>å–®åƒ¹ (Price)</label><input type="number"
                                    class="form-control" id="prod-price" required min="0"></div>
                            <div class="col-md-6 mb-3 input-group-tech"><label>åº«å­˜æ•¸é‡ (Stock)</label><input type="number"
                                    class="form-control" id="prod-stock" required min="0"></div>
                        </div>
                        <hr style="border-color: rgba(255,255,255,0.2); margin: 20px 0;">
                        <h6 style="color: var(--accent); margin-bottom: 15px;">ğŸ“¸ åœ–ç‰‡ä¸Šå‚³ (Images)</h6>
                        <div class="mb-4 input-group-tech"
                            style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px dashed rgba(6, 182, 212, 0.3);">
                            <label style="color: #fff;">ä¸»åœ–ç‰‡ä¸Šå‚³ (Main Image) - <span
                                    style="color: #ef4444;">å¿…å¡«</span></label>
                            <input type="file" class="form-control mb-2" id="prod-image-file" accept="image/*"
                                style="background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
                            <input type="hidden" id="prod-image-data" required>
                            <div class="mt-2 text-center">
                                <img id="image-preview" src=""
                                    style="max-height: 120px; border-radius: 8px; display: none; border: 2px solid var(--accent); box-shadow: 0 0 10px rgba(6,182,212,0.3);">
                                <div id="image-preview-text"
                                    style="color: #64748b; font-size: 0.85rem; margin-top: 5px;">å°šæœªé¸æ“‡åœ–ç‰‡</div>
                            </div>
                        </div>
                        <label style="color: #fff; margin-bottom: 10px; display: block;">å„è§’åº¦å±•ç¤ºåœ– (Gallery) - <span
                                style="color: #94a3b8;">é¸å¡«ï¼Œæœ€å¤š 3 å¼µ</span></label>
                        <div class="row">
                            <div class="col-md-4 mb-4 input-group-tech"
                                style="background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px;">
                                <label style="font-size: 0.85rem;">å±•ç¤ºåœ– 1</label>
                                <input type="file" class="form-control mb-2" id="prod-gallery-file-1" accept="image/*"
                                    style="background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 4px; font-size: 0.8rem;">
                                <input type="hidden" id="prod-gallery-data-1">
                                <div class="text-center mt-1"><img id="gallery-preview-1" src=""
                                        style="max-height: 80px; border-radius: 4px; display: none; border: 1px solid var(--accent);">
                                </div>
                            </div>
                            <div class="col-md-4 mb-4 input-group-tech"
                                style="background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px;">
                                <label style="font-size: 0.85rem;">å±•ç¤ºåœ– 2</label>
                                <input type="file" class="form-control mb-2" id="prod-gallery-file-2" accept="image/*"
                                    style="background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 4px; font-size: 0.8rem;">
                                <input type="hidden" id="prod-gallery-data-2">
                                <div class="text-center mt-1"><img id="gallery-preview-2" src=""
                                        style="max-height: 80px; border-radius: 4px; display: none; border: 1px solid var(--accent);">
                                </div>
                            </div>
                            <div class="col-md-4 mb-4 input-group-tech"
                                style="background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px;">
                                <label style="font-size: 0.85rem;">å±•ç¤ºåœ– 3</label>
                                <input type="file" class="form-control mb-2" id="prod-gallery-file-3" accept="image/*"
                                    style="background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 4px; font-size: 0.8rem;">
                                <input type="hidden" id="prod-gallery-data-3">
                                <div class="text-center mt-1"><img id="gallery-preview-3" src=""
                                        style="max-height: 80px; border-radius: 4px; display: none; border: 1px solid var(--accent);">
                                </div>
                            </div>
                        </div>
                        <div class="d-grid mt-2"><button type="submit" class="btn btn-login"
                                style="font-size: 1.1rem; letter-spacing: 1px;">ğŸ’¾ å„²å­˜å¯«å…¥è³‡æ–™åº« (SAVE)</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api/products';
        let adminProductsDB = [];

        document.addEventListener('DOMContentLoaded', function () {
            setInterval(() => { document.getElementById('current-time').innerText = new Date().toLocaleString('zh-TW', { hour12: false }); }, 1000);

            // ğŸ”¥ 1. æœƒå“¡åå†Š API
            async function fetchUsersFromServer() {
                try {
                    const response = await fetch('http://localhost:8000/api/users');
                    const result = await response.json();
                    if (result.status === 'success') {
                        document.getElementById('stat-users').innerText = result.data.length;
                        const usersList = document.getElementById('admin-users-list');
                        usersList.innerHTML = '';
                        result.data.forEach(user => {
                            let roleBadge = user.role === 'admin' ? '<span class="badge bg-danger ms-2" style="font-size:0.6rem;">ADMIN</span>' : '';
                            usersList.innerHTML += `<tr><td style="color: var(--accent); font-weight: bold;">${user.username} ${roleBadge}</td><td class="text-white">${user.name || '-'}</td><td class="text-white">${user.phone || '-'}</td><td class="text-white">${user.email || '-'}</td><td class="text-white"><small>${user.store_711 || '-'}</small></td><td style="color: #94a3b8;"><small>${user.created_at || '-'}</small></td></tr>`;
                        });
                    }
                } catch (e) { console.error(e); }
            }

            // ğŸ”¥ 2. è¨‚å–®ç®¡ç† API (ç²¾ç¢ºè¨ˆç®—å¾…è™•ç†èˆ‡ç‡Ÿæ”¶)
            async function fetchOrdersFromServer() {
                try {
                    const response = await fetch('http://localhost:8000/api/orders');
                    const result = await response.json();
                    if (result.status === 'success') {
                        const ordersDB = result.data;

                        // --- å„€è¡¨æ¿æ•¸æ“šæ›´æ–° ---
                        // 1. è¨ˆç®—å¾…è™•ç†è¨‚å–®æ•¸ (ç‹€æ…‹ç‚º: æº–å‚™å‡ºè²¨)
                        const pendingOrders = ordersDB.filter(o => o.status === 'æº–å‚™å‡ºè²¨').length;
                        document.getElementById('stat-orders').innerText = pendingOrders;

                        // 2. è¨ˆç®—ç´¯ç©ç‡Ÿæ”¶ (æ’é™¤å·²å–æ¶ˆ)
                        let totalRevenue = 0;
                        ordersDB.forEach(order => {
                            if (order.status !== 'å·²å–æ¶ˆ') {
                                totalRevenue += order.total_amount;
                            }
                        });
                        document.getElementById('stat-revenue').innerText = `NT$ ${totalRevenue.toLocaleString()}`;

                        // ---------------------
                        const ordersList = document.getElementById('admin-orders-list');
                        ordersList.innerHTML = '';

                        const statusOptions = ['æº–å‚™å‡ºè²¨', 'å·²å‡ºè²¨', 'å·²å®Œæˆ', 'å·²å–æ¶ˆ'];

                        ordersDB.forEach(order => {
                            const itemsSummary = order.items.map(i => `${i.product_name} x${i.quantity}`).join('<br>');

                            let selectHTML = `<select class="form-select form-select-sm" style="background: rgba(0,0,0,0.5); color: #fff; border: 1px solid var(--accent); cursor: pointer;" onchange="updateOrderStatus('${order.order_number}', this.value)">`;
                            statusOptions.forEach(opt => {
                                let selected = order.status === opt ? 'selected' : '';
                                selectHTML += `<option value="${opt}" ${selected}>${opt}</option>`;
                            });
                            selectHTML += `</select>`;

                            ordersList.innerHTML += `
                                <tr>
                                    <td style="color: var(--accent); font-weight: bold; font-family: 'Orbitron';">${order.order_number}</td>
                                    <td class="text-white">${order.shipping_name} <br><small style="color:#94a3b8;">(@${order.username})</small></td>
                                    <td class="text-white" style="font-size: 0.85rem;">${itemsSummary}</td>
                                    <td style="color: var(--accent); font-weight: bold;">NT$${order.order_amount || order.total_amount}</td>
                                    <td>${selectHTML}</td>
                                    <td style="color: #94a3b8;"><small>${order.created_at}</small></td>
                                </tr>
                            `;
                        });
                    }
                } catch (e) { console.error(e); }
            }

            // ä¿®æ”¹è¨‚å–®ç‹€æ…‹çš„è§¸ç™¼å‡½æ•¸
            window.updateOrderStatus = async function (orderNumber, newStatus) {
                try {
                    const response = await fetch(`http://localhost:8000/api/orders/${orderNumber}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    const result = await response.json();
                    if (response.ok && result.status === 'success') {
                        // ç‹€æ…‹æ›´æ–°æˆåŠŸå¾Œï¼Œé‡æ–°æŠ“å–è³‡æ–™ä»¥æ›´æ–°ã€Œå¾…è™•ç†ã€èˆ‡ã€Œç´¯ç©ç‡Ÿæ”¶ã€
                        fetchOrdersFromServer();
                    } else {
                        alert("â›” ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼š" + result.detail);
                    }
                } catch (error) {
                    console.error("Update Status Error:", error);
                    alert("âš ï¸ ä¼ºæœå™¨é€£ç·šéŒ¯èª¤ï¼");
                }
            };

            // ğŸ”¥ 3. åœ–ç‰‡ä¸Šå‚³å¼•æ“
            function setupImageUpload(fileInputId, dataInputId, previewImgId, previewTextId = null) {
                const fileInput = document.getElementById(fileInputId);
                if (!fileInput) return;
                fileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    if (file.size > 2 * 1024 * 1024) { alert("âš ï¸ æª”æ¡ˆéå¤§ï¼è«‹é¸æ“‡ 2MB ä»¥ä¸‹åœ–ç‰‡ã€‚"); this.value = ''; return; }
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const base64 = ev.target.result;
                        document.getElementById(dataInputId).value = base64;
                        const preview = document.getElementById(previewImgId);
                        preview.src = base64; preview.style.display = 'inline-block';
                        if (previewTextId) document.getElementById(previewTextId).style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                });
            }

            setupImageUpload('prod-image-file', 'prod-image-data', 'image-preview', 'image-preview-text');
            setupImageUpload('prod-gallery-file-1', 'prod-gallery-data-1', 'gallery-preview-1');
            setupImageUpload('prod-gallery-file-2', 'prod-gallery-data-2', 'gallery-preview-2');
            setupImageUpload('prod-gallery-file-3', 'prod-gallery-data-3', 'gallery-preview-3');

            fetchUsersFromServer();
            fetchOrdersFromServer();
            fetchProductsFromServer();

            document.getElementById('product-form').addEventListener('submit', (e) => { e.preventDefault(); saveProduct(); });

            // è¨˜æ†¶é ç±¤
            document.querySelectorAll('#v-pills-tab button').forEach(tab => {
                tab.addEventListener('shown.bs.tab', (e) => { localStorage.setItem('lastActiveAdminTab', e.target.id); });
            });
            const savedTab = localStorage.getItem('lastActiveAdminTab');
            if (savedTab) { const t = document.getElementById(savedTab); if (t) new bootstrap.Tab(t).show(); }
        });

        // ğŸ”¥ å•†å“ CRUD åŠŸèƒ½
        async function fetchProductsFromServer() {
            try {
                const response = await fetch(API_BASE_URL);
                const result = await response.json();
                if (result.status === 'success') {
                    adminProductsDB = result.data;
                    renderProductsTable();
                    const s = document.getElementById('stat-server');
                    s.innerHTML = 'âœ… <br>é€£ç·šæ­£å¸¸'; s.style.color = '#22c55e';
                }
            } catch (e) {
                const s = document.getElementById('stat-server');
                s.innerHTML = 'âŒ <br>é€£ç·šå¤±æ•—'; s.style.color = '#ef4444';
            }
        }

        function renderProductsTable() {
            const list = document.getElementById('admin-products-list');
            let low = 0; list.innerHTML = '';
            const catMap = { 'figure': 'æ™¯å“æ¨¡å‹', 'card': 'ç¨€æœ‰å¡ç‰‡', 'clothes': 'æ½®æµæœé£¾', 'music': 'éŸ³æ¨‚å‘¨é‚Š', 'other': 'å…¶ä»–é…ä»¶' };
            adminProductsDB.forEach(p => {
                if (p.stock <= 5) low++;
                let sCol = p.stock <= 5 ? '#ef4444' : 'var(--accent)';
                let gal = p.gallery && p.gallery.length > 0 ? `<span class="badge bg-info text-dark" style="font-size: 0.7rem; margin-left: 5px;">+${p.gallery.length}åœ–</span>` : '';
                list.innerHTML += `<tr><td style="color: #94a3b8;">#${p.id.toString().padStart(3, '0')}</td><td class="text-white"><div class="d-flex align-items-center gap-3"><img src="${p.image}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1);" onerror="this.src='../assets/images/logo.png'"><div>${p.name}${gal}</div></div></td><td class="text-white"><small class="badge bg-secondary">${catMap[p.category] || p.category}</small></td><td class="text-white">NT$${p.price}</td><td style="font-weight: bold; font-family: var(--font-title); color: ${sCol};">${p.stock}</td><td><button class="btn btn-outline-info btn-admin-action" onclick="openProductModal(${p.id})">âœï¸ ç·¨è¼¯</button><button class="btn btn-outline-danger btn-admin-action" onclick="deleteProduct(${p.id})">ğŸ—‘ï¸ åˆªé™¤</button></td></tr>`;
            });
            document.getElementById('stat-low-stock').innerText = low;
        }

        function resetImagePreview(dataId, previewId, fileId, textId = null, imgUrl = '') {
            document.getElementById(dataId).value = imgUrl;
            document.getElementById(fileId).value = '';
            const p = document.getElementById(previewId);
            if (imgUrl) { p.src = imgUrl; p.style.display = 'inline-block'; if (textId) document.getElementById(textId).style.display = 'none'; }
            else { p.src = ''; p.style.display = 'none'; if (textId) document.getElementById(textId).style.display = 'block'; }
        }

        function openProductModal(id = null) {
            const form = document.getElementById('product-form');
            form.reset();
            if (id !== null) {
                const p = adminProductsDB.find(x => x.id === id);
                if (p) {
                    document.getElementById('productModalLabel').innerText = "âš™ï¸ ç·¨è¼¯å•†å“ (EDIT CONFIG)";
                    document.getElementById('prod-id').value = p.id;
                    document.getElementById('prod-name').value = p.name;
                    document.getElementById('prod-price').value = p.price;
                    document.getElementById('prod-stock').value = p.stock;
                    document.getElementById('prod-category').value = p.category;
                    resetImagePreview('prod-image-data', 'image-preview', 'prod-image-file', 'image-preview-text', p.image);
                    resetImagePreview('prod-gallery-data-1', 'gallery-preview-1', 'prod-gallery-file-1', null, p.gallery?.[0] || '');
                    resetImagePreview('prod-gallery-data-2', 'gallery-preview-2', 'prod-gallery-file-2', null, p.gallery?.[1] || '');
                    resetImagePreview('prod-gallery-data-3', 'gallery-preview-3', 'prod-gallery-file-3', null, p.gallery?.[2] || '');
                }
            } else {
                document.getElementById('productModalLabel').innerText = "â• æ–°å¢å•†å“ (NEW PRODUCT)";
                document.getElementById('prod-id').value = '';
                resetImagePreview('prod-image-data', 'image-preview', 'prod-image-file', 'image-preview-text', '');
                resetImagePreview('prod-gallery-data-1', 'gallery-preview-1', 'prod-gallery-file-1', null, '');
                resetImagePreview('prod-gallery-data-2', 'gallery-preview-2', 'prod-gallery-file-2', null, '');
                resetImagePreview('prod-gallery-data-3', 'gallery-preview-3', 'prod-gallery-file-3', null, '');
            }
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }

        async function saveProduct() {
            const id = document.getElementById('prod-id').value;
            const img = document.getElementById('prod-image-data').value;
            if (!img) { alert("âš ï¸ è«‹å‹™å¿…ä¸Šå‚³ä¸»åœ–ç‰‡ï¼"); return; }
            const data = {
                name: document.getElementById('prod-name').value.trim(),
                price: parseInt(document.getElementById('prod-price').value),
                stock: parseInt(document.getElementById('prod-stock').value),
                category: document.getElementById('prod-category').value,
                image: img,
                gallery: [document.getElementById('prod-gallery-data-1').value, document.getElementById('prod-gallery-data-2').value, document.getElementById('prod-gallery-data-3').value].filter(i => i !== "")
            };
            const btn = document.querySelector('#product-form button[type="submit"]');
            const orig = btn.innerText; btn.disabled = true; btn.innerText = "â³ å‚³è¼¸ä¸­...";
            try {
                const res = await fetch(id ? `${API_BASE_URL}/${id}` : API_BASE_URL, { method: id ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if ((await res.json()).status === 'success') {
                    alert("âœ… å„²å­˜æˆåŠŸï¼");
                    bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                    await fetchProductsFromServer();
                }
            } catch (e) { alert("â›” å¤±æ•—ï¼è«‹æª¢æŸ¥å¾Œç«¯ã€‚"); }
            finally { btn.disabled = false; btn.innerText = orig; }
        }

        async function deleteProduct(id) {
            if (confirm("âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤å•†å“å—ï¼Ÿ")) {
                try {
                    const res = await fetch(`${API_BASE_URL}/${id}`, { method: 'DELETE' });
                    if ((await res.json()).status === 'success') await fetchProductsFromServer();
                } catch (e) { alert("â›” åˆªé™¤å¤±æ•—ï¼"); }
            }
        }
    </script>
</body>

</html>