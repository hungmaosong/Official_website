<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCG ç¸½éƒ¨å¾Œå° - æœ€é«˜æ¬Šé™ç®¡ç†</title>

    <link rel="icon" href="../assets/images/logo.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Orbitron:wght@500;700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="../css/main.css">

    <style>
        /* ==========================================
           ğŸ”¥ æ–°å¢ï¼šå…¨åŸŸåç™½æ–‡å­—é¡è‰²è¨­å®š (è§£æ±ºçœ‹ä¸åˆ°å­—çš„å•é¡Œ)
           ========================================== */
        ::selection {
            background-color: var(--accent);
            color: #000000;
        }

        ::-moz-selection {
            background-color: var(--accent);
            color: #000000;
        }

        /* æˆ°æƒ…å®¤å°ˆå±¬çš„å¾®èª¿æ¨£å¼ */
        body {
            background-color: #020617;
        }

        .admin-sidebar {
            background: rgba(15, 23, 42, 0.9);
            border-right: 1px solid rgba(6, 182, 212, 0.3);
            min-height: 100vh;
            padding: 20px;
        }

        .admin-content {
            padding: 30px;
        }

        .stat-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.2);
        }

        .stat-value {
            font-family: var(--font-title);
            font-size: 2.5rem;
            color: var(--accent);
            font-weight: 700;
        }

        .nav-pills .nav-link {
            color: #94a3b8;
            border-radius: 8px;
            margin-bottom: 10px;
            font-family: var(--font-title);
            letter-spacing: 1px;
        }

        .nav-pills .nav-link.active {
            background-color: rgba(6, 182, 212, 0.1);
            color: var(--accent);
            border-left: 4px solid var(--accent);
        }

        /* è¡¨æ ¼æ“ä½œæŒ‰éˆ•æ¨£å¼ */
        .btn-admin-action {
            padding: 4px 10px;
            font-size: 0.85rem;
            border-radius: 6px;
            margin-right: 5px;
        }

        /* æª”æ¡ˆä¸Šå‚³æŒ‰éˆ•ç¾åŒ– */
        input[type="file"]::file-selector-button {
            background-color: var(--accent);
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            padding: 5px 15px;
            margin-right: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="file"]::file-selector-button:hover {
            background-color: #fff;
        }
    </style>
</head>

<body>
    <script>
        const currentAdmin = localStorage.getItem('username');
        if (currentAdmin !== 'admin') {
            alert("ğŸš¨ åš´é‡è­¦å‘Šï¼šåµæ¸¬åˆ°æœªç¶“æˆæ¬Šçš„å­˜å–å˜—è©¦ï¼\néæœ€é«˜ç®¡ç†å“¡ (ADMIN) ç¦æ­¢é€²å…¥å¾Œå°ï¼\n\nç³»çµ±å°‡å¼·åˆ¶é©…é›¢...");
            window.location.href = '../index.html';
        }
    </script>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 admin-sidebar d-none d-md-block">
                <div class="text-center mb-5 mt-3">
                    <h4
                        style="color: #fff; font-family: var(--font-title); font-weight: bold; text-shadow: 0 0 10px var(--accent);">
                        KCG<br><span style="color: var(--accent); font-size: 0.8rem;">COMMAND CENTER</span>
                    </h4>
                </div>
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill"
                        data-bs-target="#v-pills-dashboard" type="button" role="tab">ğŸ“Š å„€è¡¨æ¿</button>
                    <button class="nav-link" id="v-pills-users-tab" data-bs-toggle="pill"
                        data-bs-target="#v-pills-users" type="button" role="tab">ğŸ•µï¸â€â™‚ï¸ æœƒå“¡åå†Š</button>
                    <button class="nav-link" id="v-pills-inventory-tab" data-bs-toggle="pill"
                        data-bs-target="#v-pills-inventory" type="button" role="tab">ğŸ“¦ å•†å“åº«å­˜</button>
                </div>
                <div class="mt-5 text-center">
                    <a href="../index.html" class="btn btn-outline-secondary btn-sm w-100">è¿”å›é¦–é </a>
                </div>
            </div>

            <div class="col-md-10 admin-content">
                <div class="d-flex justify-content-between align-items-center mb-4 pb-3"
                    style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <h2 class="section-title mb-0" style="font-size: 1.8rem;">æ­¡è¿å›ä¾†ã€‚ <span class="highlight">SYSTEM
                            ONLINE</span></h2>
                    <span style="color: #94a3b8;" id="current-time"></span>
                </div>

                <div class="tab-content" id="v-pills-tabContent">

                    <div class="tab-pane fade show active" id="v-pills-dashboard" role="tabpanel">
                        <div class="row g-4 mb-5">
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="mb-2" style="color: #cbd5e1; font-weight: 600;">è¨»å†Šæœƒå“¡ç¸½æ•¸</div>
                                    <div class="stat-value" id="stat-users">0</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="mb-2" style="color: #cbd5e1; font-weight: 600;">ä½åº«å­˜è­¦å ±</div>
                                    <div class="stat-value" id="stat-low-stock" style="color: #ef4444;">0</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="mb-2" style="color: #cbd5e1; font-weight: 600;">ç´¯ç©ç‡Ÿæ”¶</div>
                                    <div class="stat-value" style="color: #22c55e;">NT$ ---</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="mb-2" style="color: #cbd5e1; font-weight: 600;">ä¼ºæœå™¨ç‹€æ…‹</div>
                                    <div class="stat-value" id="stat-server" style="color: #f59e0b; font-size: 1.8rem;">
                                        é€£ç·šä¸­...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="v-pills-users" role="tabpanel">
                        <div class="tech-card p-4">
                            <h4 class="mb-4" style="color: #fff; font-family: var(--font-title);">æœƒå“¡åå–®è³‡æ–™åº« <span
                                    style="font-size: 0.9rem; color: var(--accent);">[ USERS_DB ]</span></h4>
                            <div class="table-responsive">
                                <table class="table tech-table align-middle">
                                    <thead>
                                        <tr style="color: #cbd5e1;">
                                            <th>ä»£è™Ÿ (å¸³è™Ÿ)</th>
                                            <th>é¡¯ç¤ºåç¨±</th>
                                            <th>é€šè¨Šé »é“ (é›»è©±)</th>
                                            <th>é›»å­ä¿¡ç®±</th>
                                            <th>é è¨­é–€å¸‚</th>
                                            <th>è¨»å†Šæ™‚é–“</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-users-list">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="v-pills-inventory" role="tabpanel">
                        <div class="tech-card p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="mb-0" style="color: #fff; font-family: var(--font-title);">å•†å“èˆ‡åº«å­˜ç®¡ç† <span
                                        style="font-size: 0.9rem; color: var(--accent);">[ PRODUCTS_DB ]</span></h4>
                                <button class="btn btn-primary" onclick="openProductModal()"
                                    style="border-radius: 50px; padding: 8px 20px; font-weight: bold;">
                                    â• æ–°å¢å•†å“
                                </button>
                            </div>
                            <p class="mb-4" style="color: #22c55e; font-weight: bold;">âœ… å·²åˆ‡æ›è‡³å¾Œç«¯æ¨¡å¼ï¼æ‰€æœ‰æ“ä½œå°‡ç›´æ¥å¯«å…¥ Python
                                çœŸå¯¦è³‡æ–™åº«ã€‚</p>
                            <div class="table-responsive">
                                <table class="table tech-table align-middle">
                                    <thead>
                                        <tr style="color: #cbd5e1;">
                                            <th width="8%">ID</th>
                                            <th width="32%">å•†å“åç¨±</th>
                                            <th width="15%">åˆ†é¡</th>
                                            <th width="15%">å–®åƒ¹</th>
                                            <th width="10%">åº«å­˜</th>
                                            <th width="20%">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-products-list">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content tech-modal">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title tech-title" id="productModalLabel">âš™ï¸ å•†å“è¨­å®š (PRODUCT CONFIG)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="product-form">
                        <input type="hidden" id="prod-id">

                        <div class="row">
                            <div class="col-md-6 mb-3 input-group-tech">
                                <label>å•†å“åç¨± (Name)</label>
                                <input type="text" class="form-control" id="prod-name" required>
                            </div>
                            <div class="col-md-6 mb-3 input-group-tech">
                                <label>æ‰€å±¬åˆ†é¡ (Category)</label>
                                <select class="form-control" id="prod-category" required style="cursor: pointer;">
                                    <option value="figure">æ™¯å“æ¨¡å‹ (figure)</option>
                                    <option value="card">ç¨€æœ‰å¡ç‰‡ (card)</option>
                                    <option value="apparel">æ½®æµæœé£¾ (apparel)</option>
                                    <option value="music">éŸ³æ¨‚å‘¨é‚Š (music)</option>
                                    <option value="other">å…¶ä»–é…ä»¶ (other)</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3 input-group-tech">
                                <label>å–®åƒ¹ (Price)</label>
                                <input type="number" class="form-control" id="prod-price" required min="0">
                            </div>
                            <div class="col-md-6 mb-3 input-group-tech">
                                <label>åº«å­˜æ•¸é‡ (Stock)</label>
                                <input type="number" class="form-control" id="prod-stock" required min="0">
                            </div>
                        </div>

                        <hr style="border-color: rgba(255,255,255,0.2); margin: 20px 0;">
                        <h6 style="color: var(--accent); margin-bottom: 15px;">ğŸ“¸ åœ–ç‰‡ä¸Šå‚³ (Images)</h6>

                        <div class="mb-4 input-group-tech"
                            style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px dashed rgba(6, 182, 212, 0.3);">
                            <label style="color: #fff;">ä¸»åœ–ç‰‡ä¸Šå‚³ (Main Image) - <span
                                    style="color: #ef4444;">å¿…å¡«</span></label>
                            <input type="file" class="form-control mb-2" id="prod-image-file" accept="image/*"
                                style="background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
                            <input type="hidden" id="prod-image-data" required>

                            <div class="mt-2 text-center">
                                <img id="image-preview" src=""
                                    style="max-height: 120px; border-radius: 8px; display: none; border: 2px solid var(--accent); box-shadow: 0 0 10px rgba(6,182,212,0.3);">
                                <div id="image-preview-text"
                                    style="color: #64748b; font-size: 0.85rem; margin-top: 5px;">å°šæœªé¸æ“‡åœ–ç‰‡</div>
                            </div>
                        </div>

                        <label style="color: #fff; margin-bottom: 10px; display: block;">å„è§’åº¦å±•ç¤ºåœ– (Gallery) - <span
                                style="color: #94a3b8;">é¸å¡«ï¼Œæœ€å¤š 3 å¼µ</span></label>
                        <div class="row">
                            <div class="col-md-4 mb-4 input-group-tech"
                                style="background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px;">
                                <label style="font-size: 0.85rem;">å±•ç¤ºåœ– 1</label>
                                <input type="file" class="form-control mb-2" id="prod-gallery-file-1" accept="image/*"
                                    style="background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 4px; font-size: 0.8rem;">
                                <input type="hidden" id="prod-gallery-data-1">
                                <div class="text-center mt-1">
                                    <img id="gallery-preview-1" src=""
                                        style="max-height: 80px; border-radius: 4px; display: none; border: 1px solid var(--accent);">
                                </div>
                            </div>

                            <div class="col-md-4 mb-4 input-group-tech"
                                style="background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px;">
                                <label style="font-size: 0.85rem;">å±•ç¤ºåœ– 2</label>
                                <input type="file" class="form-control mb-2" id="prod-gallery-file-2" accept="image/*"
                                    style="background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 4px; font-size: 0.8rem;">
                                <input type="hidden" id="prod-gallery-data-2">
                                <div class="text-center mt-1">
                                    <img id="gallery-preview-2" src=""
                                        style="max-height: 80px; border-radius: 4px; display: none; border: 1px solid var(--accent);">
                                </div>
                            </div>

                            <div class="col-md-4 mb-4 input-group-tech"
                                style="background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px;">
                                <label style="font-size: 0.85rem;">å±•ç¤ºåœ– 3</label>
                                <input type="file" class="form-control mb-2" id="prod-gallery-file-3" accept="image/*"
                                    style="background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 4px; font-size: 0.8rem;">
                                <input type="hidden" id="prod-gallery-data-3">
                                <div class="text-center mt-1">
                                    <img id="gallery-preview-3" src=""
                                        style="max-height: 80px; border-radius: 4px; display: none; border: 1px solid var(--accent);">
                                </div>
                            </div>
                        </div>

                        <div class="d-grid mt-2">
                            <button type="submit" class="btn btn-login"
                                style="font-size: 1.1rem; letter-spacing: 1px;">ğŸ’¾ å„²å­˜å¯«å…¥è³‡æ–™åº« (SAVE)</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/data.js"></script>
    <script>
        // ==========================================
        // ğŸ”¥ å¾Œç«¯ API é€£ç·šè¨­å®š
        // ==========================================
        const API_BASE_URL = 'http://localhost:8000/api/products';
        let adminProductsDB = [];

        document.addEventListener('DOMContentLoaded', function () {
            // 1. é¡¯ç¤ºå³æ™‚æ™‚é–“
            setInterval(() => {
                document.getElementById('current-time').innerText = new Date().toLocaleString('zh-TW', { hour12: false });
            }, 1000);

            // 2. è®€å–ä¸¦æ¸²æŸ“ã€Œæœƒå“¡è³‡æ–™åº«ã€
            let usersDB = JSON.parse(localStorage.getItem('usersDatabase')) || [];
            document.getElementById('stat-users').innerText = usersDB.length;

            const usersListHTML = document.getElementById('admin-users-list');
            if (usersDB.length === 0) {
                usersListHTML.innerHTML = `<tr><td colspan="6" class="text-center py-4" style="color: #94a3b8;">ç›®å‰å°šç„¡ç‰¹å‹™è¨»å†Š</td></tr>`;
            } else {
                usersDB.forEach(user => {
                    usersListHTML.innerHTML += `
                        <tr>
                            <td style="color: var(--accent); font-weight: bold;">${user.username}</td>
                            <td class="text-white">${user.name || '-'}</td>
                            <td class="text-white">${user.phone || '-'}</td>
                            <td class="text-white">${user.email || '-'}</td>
                            <td class="text-white"><small>${user.store_711 || '-'}</small></td>
                            <td style="color: #94a3b8;"><small>${user.registerTime || '-'}</small></td>
                        </tr>
                    `;
                });
            }

            // ğŸ”¥ 3. åˆæ¬¡è¼‰å…¥ï¼šå‘ Python ä¼ºæœå™¨è«‹æ±‚å•†å“è³‡æ–™åº«
            fetchProductsFromServer();

            // 4. å»ºç«‹å…±ç”¨çš„ FileReader (åœ–ç‰‡è½‰ Base64) å¼•æ“
            function setupImageUpload(fileInputId, dataInputId, previewImgId, previewTextId = null) {
                const fileInput = document.getElementById(fileInputId);
                if (!fileInput) return;

                fileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    if (file.size > 2 * 1024 * 1024) {
                        alert("âš ï¸ æª”æ¡ˆéå¤§ï¼ç‚ºé¿å…ä¼ºæœå™¨è² è¼‰ï¼Œè«‹é¸æ“‡ 2MB ä»¥ä¸‹çš„åœ–ç‰‡ã€‚");
                        this.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const base64String = event.target.result;
                        document.getElementById(dataInputId).value = base64String;

                        const previewImg = document.getElementById(previewImgId);
                        previewImg.src = base64String;
                        previewImg.style.display = 'inline-block';

                        if (previewTextId) {
                            const pText = document.getElementById(previewTextId);
                            if (pText) pText.style.display = 'none';
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }

            setupImageUpload('prod-image-file', 'prod-image-data', 'image-preview', 'image-preview-text');
            setupImageUpload('prod-gallery-file-1', 'prod-gallery-data-1', 'gallery-preview-1');
            setupImageUpload('prod-gallery-file-2', 'prod-gallery-data-2', 'gallery-preview-2');
            setupImageUpload('prod-gallery-file-3', 'prod-gallery-data-3', 'gallery-preview-3');

            // ç¶å®šè¡¨å–®é€å‡ºäº‹ä»¶
            document.getElementById('product-form').addEventListener('submit', function (e) {
                e.preventDefault();
                saveProduct(); // åŸ·è¡Œèˆ‡ä¼ºæœå™¨æºé€šçš„å„²å­˜å‡½æ•¸
            });

            // ==========================================
            // ğŸŒŸ UX å„ªåŒ–ï¼šè¨˜ä½æˆ°æƒ…å®¤æœ€å¾Œåœç•™çš„é ç±¤
            // ==========================================
            // 1. ç›£è½æ‰€æœ‰é ç±¤çš„åˆ‡æ›äº‹ä»¶ï¼Œä¸¦æŠŠ ID å­˜èµ·ä¾†
            const adminTabs = document.querySelectorAll('#v-pills-tab button[data-bs-toggle="pill"]');
            adminTabs.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function (event) {
                    localStorage.setItem('lastActiveAdminTab', event.target.id);
                });
            });

            // 2. ç¶²é è¼‰å…¥æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰è¨˜æ†¶çš„é ç±¤ï¼Œæœ‰çš„è©±å°±è‡ªå‹•åˆ‡æ›éå»
            const savedTabId = localStorage.getItem('lastActiveAdminTab');
            if (savedTabId) {
                const targetTab = document.getElementById(savedTabId);
                if (targetTab) {
                    const bsTab = new bootstrap.Tab(targetTab);
                    bsTab.show();
                }
            }
        });

        // ==========================================
        // ğŸš€ API æ ¸å¿ƒåŠŸèƒ½å€
        // ==========================================

        // è®€å–ä¼ºæœå™¨è³‡æ–™ (GET)
        async function fetchProductsFromServer() {
            try {
                const response = await fetch(API_BASE_URL);
                if (!response.ok) throw new Error('ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤');
                const result = await response.json();

                if (result.status === 'success') {
                    adminProductsDB = result.data;
                    renderProductsTable();

                    // æ›´æ–°ä¼ºæœå™¨ç‹€æ…‹ç‡ˆè™Ÿ
                    const statServer = document.getElementById('stat-server');
                    if (statServer) {
                        statServer.innerText = 'âœ… é€£ç·šæ­£å¸¸';
                        statServer.style.color = '#22c55e';
                    }
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                const statServer = document.getElementById('stat-server');
                if (statServer) {
                    statServer.innerText = 'âŒ é€£ç·šå¤±æ•—';
                    statServer.style.color = '#ef4444';
                }
                alert("âš ï¸ ç„¡æ³•é€£ç·šè‡³å¾Œç«¯ä¼ºæœå™¨ï¼è«‹ç¢ºèª Python API æ­£åœ¨é‹è¡Œä¸­ã€‚");
            }
        }

        // æ¸²æŸ“å•†å“è¡¨æ ¼ (ç¶­æŒä½ çš„æ’ç‰ˆæ ¼å¼)
        function renderProductsTable() {
            const productsListHTML = document.getElementById('admin-products-list');
            let lowStockCount = 0;
            productsListHTML.innerHTML = '';

            const categoryMap = {
                'figure': 'æ™¯å“æ¨¡å‹', 'card': 'ç¨€æœ‰å¡ç‰‡', 'apparel': 'æ½®æµæœé£¾', 'music': 'éŸ³æ¨‚å‘¨é‚Š', 'other': 'å…¶ä»–é…ä»¶'
            };

            adminProductsDB.forEach(product => {
                if (product.stock <= 5) lowStockCount++;

                let stockColor = product.stock <= 5 ? '#ef4444' : 'var(--accent)';
                let catName = categoryMap[product.category] || product.category;

                let galleryBadge = product.gallery && product.gallery.length > 0
                    ? `<span class="badge bg-info text-dark" style="font-size: 0.7rem; margin-left: 5px;">+${product.gallery.length}åœ–</span>`
                    : '';

                productsListHTML.innerHTML += `
                    <tr>
                        <td style="color: #94a3b8;">#${product.id.toString().padStart(3, '0')}</td>
                        <td class="text-white">
                            <div class="d-flex align-items-center gap-3">
                                <img src="${product.image}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1);" onerror="this.src='../assets/images/logo.png'">
                                <div>
                                    ${product.name}
                                    <div class="mt-1">${galleryBadge}</div>
                                </div>
                            </div>
                        </td>
                        <td class="text-white"><small class="badge bg-secondary">${catName}</small></td>
                        <td class="text-white">NT$${product.price}</td>
                        <td style="font-weight: bold; font-family: var(--font-title); color: ${stockColor};">${product.stock}</td>
                        <td>
                            <button class="btn btn-outline-info btn-admin-action" onclick="openProductModal(${product.id})">âœï¸ ç·¨è¼¯</button>
                            <button class="btn btn-outline-danger btn-admin-action" onclick="deleteProduct(${product.id})">ğŸ—‘ï¸ åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('stat-low-stock').innerText = lowStockCount;
        }

        // è¼”åŠ©å‡½æ•¸ï¼šç”¨ä¾†é‡ç½®é è¦½å€å¡Š
        function resetImagePreview(dataId, previewId, fileId, textId = null, imgUrl = '') {
            document.getElementById(dataId).value = imgUrl;
            document.getElementById(fileId).value = '';
            const previewImg = document.getElementById(previewId);

            if (imgUrl) {
                previewImg.src = imgUrl;
                previewImg.style.display = 'inline-block';
                if (textId) document.getElementById(textId).style.display = 'none';
            } else {
                previewImg.src = '';
                previewImg.style.display = 'none';
                if (textId) document.getElementById(textId).style.display = 'block';
            }
        }

        // é–‹å•Ÿ Modal (ç¶­æŒä½ çš„æ¬„ä½è®€å–é‚è¼¯)
        function openProductModal(id = null) {
            const modalTitle = document.getElementById('productModalLabel');
            const form = document.getElementById('product-form');
            form.reset();

            if (id !== null) {
                modalTitle.innerText = "âš™ï¸ ç·¨è¼¯å•†å“ (EDIT CONFIG)";
                const product = adminProductsDB.find(p => p.id === id);
                if (product) {
                    document.getElementById('prod-id').value = product.id;
                    document.getElementById('prod-name').value = product.name;
                    document.getElementById('prod-price').value = product.price;
                    document.getElementById('prod-stock').value = product.stock;
                    document.getElementById('prod-category').value = product.category;

                    resetImagePreview('prod-image-data', 'image-preview', 'prod-image-file', 'image-preview-text', product.image);

                    let g1 = product.gallery && product.gallery[0] ? product.gallery[0] : '';
                    let g2 = product.gallery && product.gallery[1] ? product.gallery[1] : '';
                    let g3 = product.gallery && product.gallery[2] ? product.gallery[2] : '';

                    resetImagePreview('prod-gallery-data-1', 'gallery-preview-1', 'prod-gallery-file-1', null, g1);
                    resetImagePreview('prod-gallery-data-2', 'gallery-preview-2', 'prod-gallery-file-2', null, g2);
                    resetImagePreview('prod-gallery-data-3', 'gallery-preview-3', 'prod-gallery-file-3', null, g3);
                }
            } else {
                modalTitle.innerText = "â• æ–°å¢å•†å“ (NEW PRODUCT)";
                document.getElementById('prod-id').value = '';

                resetImagePreview('prod-image-data', 'image-preview', 'prod-image-file', 'image-preview-text', '');
                resetImagePreview('prod-gallery-data-1', 'gallery-preview-1', 'prod-gallery-file-1', null, '');
                resetImagePreview('prod-gallery-data-2', 'gallery-preview-2', 'prod-gallery-file-2', null, '');
                resetImagePreview('prod-gallery-data-3', 'gallery-preview-3', 'prod-gallery-file-3', null, '');
            }

            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        // ğŸ”¥ å¯«å…¥ä¼ºæœå™¨è³‡æ–™åº« (POST / PUT)
        async function saveProduct() {
            const idVal = document.getElementById('prod-id').value;
            const mainImgData = document.getElementById('prod-image-data').value;

            if (!mainImgData) {
                alert("âš ï¸ è«‹å‹™å¿…ä¸Šå‚³ä¸€å¼µä¸»åœ–ç‰‡ï¼");
                return;
            }

            let newGallery = [
                document.getElementById('prod-gallery-data-1').value,
                document.getElementById('prod-gallery-data-2').value,
                document.getElementById('prod-gallery-data-3').value
            ].filter(img => img !== "");

            // æ‰“åŒ…æˆ JSON æ ¼å¼
            const productData = {
                name: document.getElementById('prod-name').value.trim(),
                price: parseInt(document.getElementById('prod-price').value),
                stock: parseInt(document.getElementById('prod-stock').value),
                category: document.getElementById('prod-category').value,
                image: mainImgData,
                gallery: newGallery
            };

            // æŒ‰éˆ•é˜²é€£é»ä¿è­·
            const btn = document.querySelector('#product-form button[type="submit"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "â³ ä¼ºæœå™¨å‚³è¼¸ä¸­...";

            try {
                // å¦‚æœæœ‰ ID å°±æ˜¯ä¿®æ”¹(PUT)ï¼Œæ²’æœ‰ ID å°±æ˜¯æ–°å¢(POST)
                const method = idVal ? 'PUT' : 'POST';
                const url = idVal ? `${API_BASE_URL}/${idVal}` : API_BASE_URL;

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                if (!response.ok) throw new Error('API è«‹æ±‚å¤±æ•—');
                const result = await response.json();

                if (result.status === 'success') {
                    alert(idVal ? "âœ… å•†å“è³‡æ–™ä¿®æ”¹æˆåŠŸï¼" : "âœ… æ–°å¢å•†å“å·²å¯«å…¥è³‡æ–™åº«ï¼");
                    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                    if (modal) modal.hide();

                    // æˆåŠŸå¾Œï¼Œè¦æ±‚ä¼ºæœå™¨é‡æ–°ç™¼é€æœ€æ–°çš„å®Œæ•´æ¸…å–®ä¾†æ›´æ–°ç•«é¢ï¼
                    await fetchProductsFromServer();
                }
            } catch (error) {
                console.error("Save Error:", error);
                alert("â›” å„²å­˜å¤±æ•—ï¼è«‹æª¢æŸ¥å¾Œç«¯ä¼ºæœå™¨æ˜¯å¦æ­£å¸¸é‹ä½œã€‚");
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        // ğŸ”¥ åˆªé™¤ä¼ºæœå™¨å•†å“ (DELETE)
        async function deleteProduct(id) {
            if (confirm("âš ï¸ åš´é‡è­¦å‘Šï¼šç¢ºå®šè¦å°‡æ­¤å•†å“å¾ã€ŒçœŸå¯¦è³‡æ–™åº«ã€ä¸­æ°¸ä¹…åˆªé™¤å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼")) {
                try {
                    const response = await fetch(`${API_BASE_URL}/${id}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) throw new Error('API è«‹æ±‚å¤±æ•—');
                    const result = await response.json();

                    if (result.status === 'success') {
                        // åˆªé™¤æˆåŠŸå¾Œï¼Œé‡æ–°æ•´ç†ç•«é¢æ¸…å–®
                        await fetchProductsFromServer();
                    }
                } catch (error) {
                    console.error("Delete Error:", error);
                    alert("â›” åˆªé™¤å¤±æ•—ï¼è«‹æª¢æŸ¥å¾Œç«¯ä¼ºæœå™¨æ˜¯å¦æ­£å¸¸é‹ä½œã€‚");
                }
            }
        }
    </script>
</body>

</html>